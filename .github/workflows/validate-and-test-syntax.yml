name: Validate and Test Syntax

on:
  push:
    branches: [main, master, develop]
  pull_request:
    branches: [main, master]

jobs:
  validate-and-test:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Validate JSON files
        run: |
          echo "ðŸ” Validating JSON files..."

          # Validate package.json
          if jq . package.json > /dev/null 2>&1; then
            echo "âœ… package.json: valid JSON"
          else
            echo "âŒ package.json: invalid JSON"
            exit 1
          fi

          # Validate messages.json
          if jq . messages.json > /dev/null 2>&1; then
            echo "âœ… messages.json: valid JSON"
          else
            echo "âŒ messages.json: invalid JSON"
            exit 1
          fi

          # Validate completions file
          if [ -f "Completions/NunjucksToolbox.sublime-completions" ]; then
            if jq . Completions/NunjucksToolbox.sublime-completions > /dev/null 2>&1; then
              echo "âœ… NunjucksToolbox.sublime-completions: valid JSON"
            else
              echo "âŒ NunjucksToolbox.sublime-completions: invalid JSON"
              exit 1
            fi
          fi

      - name: Validate YAML files
        run: |
          echo "ðŸ” Validating YAML syntax files..."

          # Check if syntax files exist and have basic structure
          if [ -f "Syntaxes/NunjucksToolbox.sublime-syntax" ]; then
            if grep -q "^%YAML" Syntaxes/NunjucksToolbox.sublime-syntax; then
              echo "âœ… NunjucksToolbox.sublime-syntax: valid YAML header"
            else
              echo "âš ï¸  NunjucksToolbox.sublime-syntax: missing YAML header"
            fi
          fi

      - name: Check file structure
        run: |
          echo "ðŸ” Checking required files and directories..."

          # List current directory contents for debugging
          echo "ðŸ“ Current directory contents:"
          ls -la

          # Check required directories with more verbose output
          REQUIRED_DIRS=("Completions" "Keymaps" "Menu" "Settings" "Syntaxes")
          for dir in "${REQUIRED_DIRS[@]}"; do
            if [ -d "$dir" ]; then
              echo "âœ… Directory $dir exists"
            else
              echo "âŒ Directory $dir missing"
              ls -la "$dir" 2>/dev/null || echo "   Directory not found or not accessible"
              exit 1
            fi
          done

          # Check required files
          REQUIRED_FILES=("package.json" "messages.json")
          for file in "${REQUIRED_FILES[@]}"; do
            if [ -f "$file" ]; then
              echo "âœ… File $file exists"
            else
              echo "âŒ File $file missing"
              exit 1
            fi
          done

          # Note: Commands directory exists but is intentionally empty (no Python files needed)
          if [ -d "Commands" ]; then
            echo "âœ… Directory Commands exists (intentionally empty - no Python files required)"
          else
            echo "âš ï¸  Directory Commands missing (but not required for current architecture)"
          fi

      - name: Validate scope consistency
        run: |
          echo "ðŸ” Checking scope consistency..."

          # Check that all files use the same scope
          MAIN_SCOPE="text.html.nunjucks-toolbox"

          # Check keymaps
          if grep -r "$MAIN_SCOPE" Keymaps/ >/dev/null 2>&1; then
            echo "âœ… Keymaps: scope consistency verified"
          else
            echo "âš ï¸  Keymaps: check scope references"
          fi

          # Check context menu
          if grep -q "$MAIN_SCOPE" Menu/Context.sublime-menu 2>/dev/null; then
            echo "âœ… Context menu: scope consistency verified"
          else
            echo "âš ï¸  Context menu: check scope references"
          fi

      - name: Generate test report
        run: |
          echo "# Syntax Validation Report" > test-report.md
          echo "- âœ… JSON file validation completed" >> test-report.md
          echo "- âœ… YAML syntax validation completed" >> test-report.md  
          echo "- âœ… File structure validation completed" >> test-report.md
          echo "- âœ… Scope consistency check completed" >> test-report.md
          echo "- âœ… Pure configuration-based extension validated" >> test-report.md
          echo "" >> test-report.md
          echo "All validation checks completed successfully using built-in tools." >> test-report.md
          echo "Extension uses only Sublime Text configuration files (no Python scripts required)." >> test-report.md

          echo "âœ… Test report generated"

      - name: Upload test artifacts
        uses: actions/upload-artifact@v4
        with:
          name: syntax-validation-report
          path: test-report.md
